<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monopoly Money - Game Room</title>
  
  <!-- Google Material Symbols -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #F5F5F5;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .menu-btn {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
      border: none;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .menu-btn .material-symbols-rounded {
      font-size: 28px;
      color: white;
    }

    .reset-btn {
      width: 56px;
      height: 56px;
      background: white;
      border: 2px solid #E5E7EB;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .reset-btn .material-symbols-rounded {
      font-size: 28px;
      color: #1F2937;
    }

    .greeting {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 24px;
      font-weight: 600;
      color: #1F2937;
      margin-bottom: 8px;
    }

    .room-id {
      font-size: 16px;
      color: #9CA3AF;
      margin-bottom: 30px;
    }

    .balance-card {
      background: linear-gradient(135deg, #EDE9FE 0%, #DBEAFE 100%);
      border: 3px solid #8B5CF6;
      border-radius: 24px;
      padding: 32px;
      margin-bottom: 20px;
      text-align: center;
    }

    .balance-amount {
      font-size: 56px;
      font-weight: 700;
      color: #8B5CF6;
      margin-bottom: 8px;
    }

    .balance-label {
      font-size: 16px;
      color: #6B7280;
    }

    .undo-btn {
      background: white;
      border: 2px solid #1F2937;
      border-radius: 16px;
      padding: 16px 24px;
      font-size: 18px;
      font-weight: 600;
      color: #1F2937;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
      width: 100%;
      transition: all 0.3s ease;
    }

    .undo-btn:hover {
      background: #F9FAFB;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .manage-property-btn {
      background: #000000;
      border: none;
      border-radius: 16px;
      padding: 20px;
      font-size: 20px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      margin-bottom: 40px;
      width: 100%;
      transition: all 0.3s ease;
    }

    .manage-property-btn:hover {
      background: #1F2937;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .opponent-section {
      margin-bottom: 20px;
    }

    .opponent-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      color: #6B7280;
      margin-bottom: 16px;
    }

    .opponent-label .material-symbols-rounded {
      font-size: 20px;
      color: #8B5CF6;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-left: 4px;
    }

    .status-dot.online {
      background: #10B981;
    }

    .status-dot.offline {
      background: #EF4444;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    .send-player-btn {
      background: #6366F1;
      border: none;
      border-radius: 16px;
      padding: 20px;
      font-size: 18px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .send-player-btn:hover {
      background: #8B5CF6;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .send-bank-btn {
      background: #10B981;
      border: none;
      border-radius: 16px;
      padding: 20px;
      font-size: 18px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .send-bank-btn:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
    }

    .leave-btn {
      background: #EF4444;
      border: none;
      border-radius: 16px;
      padding: 20px;
      font-size: 20px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
    }

    .leave-btn:hover {
      background: #DC2626;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.3);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 24px;
      padding: 32px;
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .modal-icon {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-icon.player {
      background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
    }

    .modal-icon.bank {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    }

    .modal-icon .material-symbols-rounded {
      font-size: 32px;
      color: white;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 600;
      color: #1F2937;
    }

    .calculator-display {
      background: #F3F4F6;
      border: 2px solid #E5E7EB;
      border-radius: 16px;
      padding: 20px;
      font-size: 32px;
      font-weight: 600;
      color: #1F2937;
      text-align: right;
      margin-bottom: 20px;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .amount-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .amount-btn {
      background: #000000;
      border: none;
      border-radius: 12px;
      padding: 20px;
      font-size: 20px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .amount-btn:hover {
      background: #1F2937;
      transform: scale(1.05);
    }

    .amount-btn:active {
      transform: scale(0.95);
    }

    .backspace-btn {
      background: #EF4444;
      border: none;
      border-radius: 12px;
      padding: 16px;
      font-size: 18px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
      transition: all 0.2s ease;
    }

    .backspace-btn:hover {
      background: #DC2626;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
    }

    .cancel-btn {
      flex: 1;
      background: #F3F4F6;
      border: none;
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      color: #6B7280;
      cursor: pointer;
    }

    .confirm-btn {
      flex: 1;
      border: none;
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      cursor: pointer;
    }

    .confirm-btn.player {
      background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
    }

    .confirm-btn.bank {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #1F2937;
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .toast.show {
      display: block;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: linear-gradient(135deg, #1F2937 0%, #111827 100%);
  color: white;
  padding: 16px 24px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 500;
  z-index: 2000;
  display: none;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  min-width: 280px;
  border: 2px solid rgba(255, 255, 255, 0.1);
}

.toast.show {
  display: block;
  animation: slideUpFade 0.3s ease;
}

@keyframes slideUpFade {
  0% {
    opacity: 0;
    transform: translateY(20px) scale(0.95);
  }
  100% {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="menu-btn">
        <span class="material-symbols-rounded">chat_bubble</span>
      </button>
      <button class="reset-btn" onclick="resetBalances()">
        <span class="material-symbols-rounded">history</span>
      </button>
    </div>

    <div class="greeting">
      <span>ðŸ‘‹</span>
      <span>Hello <span id="playerName">{Name}</span>!</span>
    </div>
    
    <div class="room-id">Room ID #<span id="roomId">000000</span></div>

    <div class="balance-card">
      <div class="balance-amount" id="balance">3,000</div>
      <div class="balance-label">Balance Amount</div>
    </div>

    <button class="undo-btn" onclick="undoTransaction()">
      <span class="material-symbols-rounded">undo</span>
      Undo
    </button>

    <button class="manage-property-btn" onclick="viewPlayerProperty()">
      Manage Property
    </button>

    <div class="opponent-section">
      <div class="opponent-label">
        <span class="material-symbols-rounded">person</span>
        <span>Opp.Player: <span id="opponentName">{Name}</span></span>
        <span class="status-dot" id="opponentStatus"></span>
      </div>
    </div>

    <div class="action-buttons">
      <button class="send-player-btn" onclick="openModal('player')">
        Send to Player
      </button>
      <button class="send-bank-btn" onclick="openModal('bank')">
        Send to Bank
      </button>
    </div>

    <button class="leave-btn" onclick="leaveRoom()">
      Leave Room
    </button>
  </div>

  <!-- Amount Modal -->
  <div class="modal" id="amountModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-icon" id="modalIcon">
          <span class="material-symbols-rounded" id="modalIconSymbol">person</span>
        </div>
        <div class="modal-title" id="modalTitle">Send to Player</div>
      </div>

      <div class="calculator-display" id="calculatorDisplay">â‚¹ 0</div>

      <div class="amount-grid">
        <button class="amount-btn" onclick="addAmount(1)">1</button>
        <button class="amount-btn" onclick="addAmount(5)">5</button>
        <button class="amount-btn" onclick="addAmount(10)">10</button>
        <button class="amount-btn" onclick="addAmount(20)">20</button>
        <button class="amount-btn" onclick="addAmount(50)">50</button>
        <button class="amount-btn" onclick="addAmount(100)">100</button>
        <button class="amount-btn" onclick="addAmount(500)">500</button>
      </div>

      <button class="backspace-btn" onclick="backspace()">
        <span class="material-symbols-rounded">backspace</span>
        Backspace
      </button>

      <div class="modal-actions">
        <button class="cancel-btn" onclick="closeModal()">Cancel</button>
        <button class="confirm-btn" id="confirmBtn" onclick="confirmTransaction()">Send</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <script>
    const firebaseConfig = {
      aapiKey: "AIzaSyDrPA---Ak_l9jqwHouWiC2byZH6EdR9Ts",
  authDomain: "monopolymoneyapp.firebaseapp.com",
  databaseURL: "https://monopolymoneyapp-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "monopolymoneyapp",
  storageBucket: "monopolymoneyapp.firebasestorage.app",
  messagingSenderId: "734008146391",
  appId: "1:734008146391:web:8ebbf21a9c324b25587392",
  measurementId: "G-3377SYGJYX"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
  </script>
  
  <script>
    let roomId = new URLSearchParams(window.location.search).get('room');
    let currentPlayer = new URLSearchParams(window.location.search).get('player');
    let currentAmount = 0;
    let currentMode = 'player';
    let lastTransaction = null;

    if (!roomId || !currentPlayer) {
      window.location.href = 'room.html';
    }

    document.getElementById('roomId').textContent = roomId;

    const playerRef = database.ref(`rooms/${roomId}/${currentPlayer}`);
    const opponentPlayer = currentPlayer === 'player1' ? 'player2' : 'player1';
    const opponentRef = database.ref(`rooms/${roomId}/${opponentPlayer}`);

    playerRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (data) {
        document.getElementById('playerName').textContent = data.name || '{Name}';
        document.getElementById('balance').textContent = formatNumber(data.balance ?? 3000);
      }
    });

    opponentRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (data) {
        document.getElementById('opponentName').textContent = data.name || '{Name}';
        const statusDot = document.getElementById('opponentStatus');
        if (data.online) {
          statusDot.className = 'status-dot online';
        } else {
          statusDot.className = 'status-dot offline';
        }
      }
    });

    opponentRef.child('online').on('value', (snapshot) => {
      const isOnline = snapshot.val();
      if (isOnline) {
        showToast('Opponent joined the room');
      } else if (snapshot.val() === false) {
        showToast('Opponent left the room');
      }
    });

    playerRef.child('online').set(true);
    playerRef.child('online').onDisconnect().set(false);

    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function openModal(mode) {
      currentMode = mode;
      currentAmount = 0;
      updateDisplay();
      
      const modal = document.getElementById('amountModal');
      const icon = document.getElementById('modalIcon');
      const iconSymbol = document.getElementById('modalIconSymbol');
      const title = document.getElementById('modalTitle');
      const confirmBtn = document.getElementById('confirmBtn');
      
      if (mode === 'player') {
        icon.className = 'modal-icon player';
        iconSymbol.textContent = 'person';
        title.textContent = 'Send to Player';
        confirmBtn.className = 'confirm-btn player';
      } else {
        icon.className = 'modal-icon bank';
        iconSymbol.textContent = 'account_balance';
        title.textContent = 'Send to Bank';
        confirmBtn.className = 'confirm-btn bank';
      }
      
      modal.classList.add('active');
    }

    function closeModal() {
      document.getElementById('amountModal').classList.remove('active');
      currentAmount = 0;
    }

    function addAmount(value) {
      currentAmount += value;
      updateDisplay();
    }

    function backspace() {
      const amounts = [];
      let remaining = currentAmount;
      const denominations = [1000, 500, 200, 100, 50, 20, 10, 5, 1];
      
      for (let denom of denominations) {
        while (remaining >= denom) {
          amounts.push(denom);
          remaining -= denom;
        }
      }
      
      if (amounts.length > 0) {
        amounts.pop();
        currentAmount = amounts.reduce((sum, val) => sum + val, 0);
        updateDisplay();
      }
    }

    function updateDisplay() {
      document.getElementById('calculatorDisplay').textContent = 'â‚¹ ' + formatNumber(currentAmount);
    }

    async function confirmTransaction() {
      if (currentAmount === 0) {
        showToast('Please enter an amount');
        return;
      }

      const playerSnapshot = await playerRef.once('value');
      const playerData = playerSnapshot.val();
      const currentBalance = playerData.balance ?? 3000;

      if (currentAmount > currentBalance) {
        showToast('Insufficient balance');
        return;
      }

      lastTransaction = {
        mode: currentMode,
        amount: currentAmount,
        previousBalance: currentBalance
      };

      if (currentMode === 'player') {
        const opponentSnapshot = await opponentRef.once('value');
        const opponentData = opponentSnapshot.val();
        const opponentBalance = opponentData.balance ?? 3000;

        await playerRef.update({ balance: currentBalance - currentAmount });
        await opponentRef.update({ balance: opponentBalance + currentAmount });
        showToast(`Sent â‚¹${formatNumber(currentAmount)} to opponent`);
        
        lastTransaction.opponentPreviousBalance = opponentBalance;
      } else {
        await playerRef.update({ balance: currentBalance - currentAmount });
        showToast(`Sent â‚¹${formatNumber(currentAmount)} to bank`);
      }

      closeModal();
    }

    async function undoTransaction() {
      if (!lastTransaction) {
        showToast('No transaction to undo');
        return;
      }

      await playerRef.update({ balance: lastTransaction.previousBalance });
      
      if (lastTransaction.mode === 'player' && lastTransaction.opponentPreviousBalance !== undefined) {
        await opponentRef.update({ balance: lastTransaction.opponentPreviousBalance });
      }

      showToast('Transaction undone');
      lastTransaction = null;
    }

    async function resetBalances() {
      if (confirm('Reset both players to â‚¹3,000?')) {
        await playerRef.update({ balance: 3000 });
        await opponentRef.update({ balance: 3000 });
        showToast('Balances reset to â‚¹3,000');
      }
    }

    function leaveRoom() {
      if (confirm('Are you sure you want to leave the room?')) {
        playerRef.child('online').set(false);
        window.location.href = 'room.html';
      }
    }

    function viewPlayerProperty() {
      window.location.href = `property-player.html?room=${roomId}&player=${currentPlayer}`;
    }
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Real-time transaction notifications for Players
function setupPlayerNotifications() {
  const transactionsRef = database.ref(`rooms/${roomId}/transactions`);
  
  // Listen for new transactions
  transactionsRef.limitToLast(1).on('child_added', (snapshot) => {
    const transaction = snapshot.val();
    
    // Only show notification if transaction is recent (within last 3 seconds)
    const now = Date.now();
    if (now - transaction.timestamp < 3000) {
      displayPlayerNotification(transaction);
    }
  });
}

function displayPlayerNotification(transaction) {
  const { type, from, to, amount, fromName, toName } = transaction;
  
  let message = '';
  
  if (type === 'player_to_player') {
    // Show if I'm the receiver
    if (to === currentPlayer) {
      message = `ðŸ’° ${fromName} sent you ${formatCurrency(amount)}`;
    }
    // Show if I'm the sender
    else if (from === currentPlayer) {
      message = `âœ… You sent ${formatCurrency(amount)} to ${toName}`;
    }
    // Show if I'm watching another transaction
    else {
      message = `ðŸ‘€ ${fromName} sent ${formatCurrency(amount)} to ${toName}`;
    }
  } else if (type === 'player_to_bank') {
    if (from === currentPlayer) {
      message = `ðŸ¦ You sent ${formatCurrency(amount)} to Bank`;
    } else {
      message = `ðŸ¦ ${fromName} sent ${formatCurrency(amount)} to Bank`;
    }
  } else if (type === 'bank_to_player' || type === 'banker_to_player') {
    if (to === currentPlayer) {
      message = `ðŸ’¸ Banker paid you ${formatCurrency(amount)}`;
    } else {
      message = `ðŸ’¸ Banker paid ${formatCurrency(amount)} to ${toName}`;
    }
  } else if (type === 'banker_collect') {
    if (from === currentPlayer) {
      message = `âš ï¸ Banker collected ${formatCurrency(amount)} from you`;
    } else {
      message = `ðŸ‘€ Banker collected ${formatCurrency(amount)} from ${fromName}`;
    }
  }
  
  if (message) {
    showNotification(message);
  }
}

// Call this in initialization (after roomId and currentPlayer are set)
setupPlayerNotifications();

async function sendMoney() {
  if (selectedAmount === 0) {
    showNotification('Please select an amount');
    return;
  }

  if (!currentAction) return;

  const myRef = database.ref(`rooms/${roomId}/${currentPlayer}`);
  const mySnapshot = await myRef.once('value');
  const myData = mySnapshot.val();
  const myBalance = myData.balance ?? 3000;

  if (selectedAmount > myBalance) {
    showNotification('Insufficient balance');
    return;
  }

  if (currentAction === 'player') {
    // Send to other player
    const otherPlayer = currentPlayer === 'player1' ? 'player2' : 'player1';
    const otherRef = database.ref(`rooms/${roomId}/${otherPlayer}`);
    const otherSnapshot = await otherRef.once('value');
    const otherData = otherSnapshot.val();

    if (!otherData) {
      showNotification('Other player not found');
      return;
    }

    const otherBalance = otherData.balance ?? 3000;

    // Update balances
    await myRef.update({ balance: myBalance - selectedAmount });
    await otherRef.update({ balance: otherBalance + selectedAmount });

    // Log transaction
    await database.ref(`rooms/${roomId}/transactions`).push({
      type: 'player_to_player',
      from: currentPlayer,
      fromName: myData.name,
      to: otherPlayer,
      toName: otherData.name,
      amount: selectedAmount,
      timestamp: Date.now()
    });

    showNotification(`Sent ${formatCurrency(selectedAmount)} to ${otherData.name}`);
    
  } else if (currentAction === 'bank') {
    // Send to bank (deduct only)
    await myRef.update({ balance: myBalance - selectedAmount });

    // Log transaction
    await database.ref(`rooms/${roomId}/transactions`).push({
      type: 'player_to_bank',
      from: currentPlayer,
      fromName: myData.name,
      amount: selectedAmount,
      timestamp: Date.now()
    });

    showNotification(`Sent ${formatCurrency(selectedAmount)} to Bank`);
  }

  closeAmountModal();
}

  </script>
</body>
</html>