<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Banker Desktop Dashboard - Monopoly Money</title>
  
  <!-- Google Material Symbols -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #F5F5F5;
      min-height: 100vh;
      padding: 24px;
    }

    .dashboard {
      max-width: 1600px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      background: white;
      padding: 24px 32px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .logo-icon .material-symbols-rounded {
      font-size: 32px;
      color: white;
      font-variation-settings: 'FILL' 1, 'wght' 400;
    }

    .header-title-group h1 {
      font-size: 28px;
      font-weight: 700;
      color: #1F2937;
      margin-bottom: 4px;
    }

    .room-id {
      font-size: 16px;
      color: #6B7280;
      font-weight: 500;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .header-btn {
      background: #000000;
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-btn:hover {
      background: #1F2937;
      transform: translateY(-2px);
    }

    .header-btn.reset {
      background: #EF4444;
    }

    .header-btn.reset:hover {
      background: #DC2626;
    }

    .header-btn.leave {
      background: #F59E0B;
    }

    .header-btn.leave:hover {
      background: #D97706;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    .player-card {
      background: white;
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .player-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .player-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .player-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 28px;
    }

    .player-name {
      font-size: 20px;
      font-weight: 700;
      color: #1F2937;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #10B981;
    }

    .status-indicator.offline {
      background: #EF4444;
    }

    .balance-display {
      background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%);
      border: 2px solid #C7D2FE;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      text-align: center;
    }

    .balance-label {
      font-size: 14px;
      color: #6B7280;
      margin-bottom: 8px;
    }

    .balance-amount {
      font-size: 48px;
      font-weight: 700;
      color: #6366F1;
    }

    .player-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .action-btn {
      background: #000000;
      border: none;
      border-radius: 12px;
      padding: 14px;
      font-size: 14px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .action-btn:hover {
      background: #1F2937;
      transform: translateY(-2px);
    }

    .action-btn.pay {
      background: #10B981;
    }

    .action-btn.pay:hover {
      background: #059669;
    }

    .action-btn.collect {
      background: #EF4444;
    }

    .action-btn.collect:hover {
      background: #DC2626;
    }

    .action-btn:disabled {
      background: #9CA3AF;
      cursor: not-allowed;
      transform: none;
    }

    .waiting-message {
      text-align: center;
      color: #9CA3AF;
      font-size: 14px;
      padding: 20px;
      background: #F9FAFB;
      border-radius: 12px;
    }

    .properties-section {
      background: white;
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #1F2937;
    }

    .property-quick-actions {
      display: flex;
      gap: 12px;
    }

    .property-btn {
      background: #000000;
      border: none;
      border-radius: 12px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .property-btn:hover {
      background: #1F2937;
      transform: translateY(-2px);
    }

    .filter-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .filter-tab {
      background: #F9FAFB;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      color: #6B7280;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .filter-tab.active {
      background: #000000;
      color: white;
    }

    .properties-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
    }

    .property-item {
      border: 2px solid #E5E7EB;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .property-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .property-color-bar {
      height: 6px;
      border-radius: 3px;
      margin-bottom: 12px;
    }

    .property-name-text {
      font-size: 13px;
      font-weight: 700;
      color: #1F2937;
      margin-bottom: 8px;
      min-height: 32px;
    }

    .property-price {
      font-size: 12px;
      color: #6B7280;
      margin-bottom: 4px;
    }

    .property-owner {
      font-size: 12px;
      color: #10B981;
      font-weight: 600;
    }

    .property-owner.mortgaged {
      color: #EF4444;
    }

    .property-owner.available {
      color: #6B7280;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 24px;
      padding: 32px;
      max-width: 400px;
      width: 90%;
    }

    .modal-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: #1F2937;
      margin-bottom: 8px;
    }

    .modal-subtitle {
      font-size: 14px;
      color: #6B7280;
    }

    .calculator-display {
      background: #D1FAE5;
      border: 2px solid #6EE7B7;
      border-radius: 16px;
      padding: 24px;
      font-size: 40px;
      font-weight: 700;
      color: #10B981;
      text-align: center;
      margin-bottom: 20px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .amount-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .amount-btn {
      background: #000000;
      border: none;
      border-radius: 12px;
      padding: 20px;
      font-size: 18px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .amount-btn:hover {
      background: #1F2937;
      transform: scale(1.05);
    }

    .backspace-btn {
      background: #EF4444;
      border: none;
      border-radius: 12px;
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
    }

    .backspace-btn:hover {
      background: #DC2626;
    }

    .modal-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .modal-btn {
      background: #000000;
      border: none;
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-btn:hover {
      background: #1F2937;
    }

    .modal-btn.cancel {
      background: #F9FAFB;
      color: #6B7280;
      border: 2px solid #E5E7EB;
    }

    .modal-btn.cancel:hover {
      background: #E5E7EB;
    }

    .modal-btn.confirm-pay {
      background: #10B981;
    }

    .modal-btn.confirm-pay:hover {
      background: #059669;
    }

    .modal-btn.confirm-collect {
      background: #EF4444;
    }

    .modal-btn.confirm-collect:hover {
      background: #DC2626;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #1F2937;
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .toast.show {
      display: block;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

  </style>
</head>
<body>
  <div class="dashboard">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <div class="logo-icon">
          <span class="material-symbols-rounded">account_balance</span>
        </div>
        <div class="header-title-group">
          <h1>Banker Dashboard</h1>
          <div class="room-id">Room ID: #<span id="roomIdDisplay">Loading...</span></div>
        </div>
      </div>
      <div class="header-actions">
        <button class="header-btn" onclick="viewMortgaged()">
          <span class="material-symbols-rounded">payments</span>
          Mortgaged
        </button>
        <button class="header-btn reset" onclick="resetBalances()">
          <span class="material-symbols-rounded">refresh</span>
          Reset All
        </button>
        <button class="header-btn leave" onclick="leaveRoom()">
          <span class="material-symbols-rounded">logout</span>
          Leave Room
        </button>
      </div>
    </div>

    <!-- Players Grid -->
    <div class="main-grid">
      <!-- Player 1 -->
      <div class="player-card">
        <div class="player-header">
          <div class="player-info">
            <div class="player-icon">
              <span class="material-symbols-rounded">person</span>
            </div>
            <div>
              <div class="player-name" id="player1Name">Waiting for player...</div>
            </div>
          </div>
          <div class="status-indicator offline" id="player1Status"></div>
        </div>

        <div class="balance-display">
          <div class="balance-label">Current Balance</div>
          <div class="balance-amount" id="player1Balance">₹ 3,000</div>
        </div>

        <div class="player-actions" id="player1Actions">
          <button class="action-btn pay" onclick="openPayModal('player1')" disabled>
            <span class="material-symbols-rounded">add</span>
            Pay
          </button>
          <button class="action-btn collect" onclick="openCollectModal('player1')" disabled>
            <span class="material-symbols-rounded">remove</span>
            Collect
          </button>
        </div>
        <div class="waiting-message" id="player1Waiting">Waiting for player to join...</div>
      </div>

      <!-- Player 2 -->
      <div class="player-card">
        <div class="player-header">
          <div class="player-info">
            <div class="player-icon">
              <span class="material-symbols-rounded">person</span>
            </div>
            <div>
              <div class="player-name" id="player2Name">Waiting for player...</div>
            </div>
          </div>
          <div class="status-indicator offline" id="player2Status"></div>
        </div>

        <div class="balance-display">
          <div class="balance-label">Current Balance</div>
          <div class="balance-amount" id="player2Balance">₹ 3,000</div>
        </div>

        <div class="player-actions" id="player2Actions">
          <button class="action-btn pay" onclick="openPayModal('player2')" disabled>
            <span class="material-symbols-rounded">add</span>
            Pay
          </button>
          <button class="action-btn collect" onclick="openCollectModal('player2')" disabled>
            <span class="material-symbols-rounded">remove</span>
            Collect
          </button>
        </div>
        <div class="waiting-message" id="player2Waiting">Waiting for player to join...</div>
      </div>
    </div>

    <!-- Properties Section -->
    <div class="properties-section">
      <div class="section-header">
        <div class="section-title">Properties</div>
        <div class="property-quick-actions">
          <button class="property-btn" onclick="viewProperty()">
            <span class="material-symbols-rounded">apartment</span>
            Manage Properties
          </button>
        </div>
      </div>

      <div class="filter-tabs">
        <button class="filter-tab active" onclick="filterProperties('all', this)">All</button>
        <button class="filter-tab" onclick="filterProperties('available', this)">Available</button>
        <button class="filter-tab" onclick="filterProperties('owned', this)">Owned</button>
        <button class="filter-tab" onclick="filterProperties('mortgaged', this)">Mortgaged</button>
      </div>

      <div class="properties-grid" id="propertiesGrid">
        <!-- Properties will be dynamically loaded here -->
      </div>
    </div>
  </div>

  <!-- Pay/Collect Modal -->
  <div class="modal" id="transactionModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Pay Money</div>
        <div class="modal-subtitle" id="modalSubtitle">Player Name</div>
      </div>
      
      <div class="calculator-display" id="calculatorDisplay">₹ 0</div>
      
      <div class="amount-grid">
        <button class="amount-btn" onclick="addAmount(1)">1</button>
        <button class="amount-btn" onclick="addAmount(5)">5</button>
        <button class="amount-btn" onclick="addAmount(10)">10</button>
        <button class="amount-btn" onclick="addAmount(20)">20</button>
        <button class="amount-btn" onclick="addAmount(50)">50</button>
        <button class="amount-btn" onclick="addAmount(100)">100</button>
        <button class="amount-btn" onclick="addAmount(500)">500</button>
      </div>

      <button class="backspace-btn" onclick="backspace()">
        <span class="material-symbols-rounded">backspace</span>
        Backspace
      </button>

      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
        <button class="modal-btn confirm-pay" id="confirmBtn" onclick="confirmTransaction()">Confirm</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDrPA---Ak_l9jqwHouWiC2byZH6EdR9Ts",
  authDomain: "monopolymoneyapp.firebaseapp.com",
  databaseURL: "https://monopolymoneyapp-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "monopolymoneyapp",
  storageBucket: "monopolymoneyapp.firebasestorage.app",
  messagingSenderId: "734008146391",
  appId: "1:734008146391:web:8ebbf21a9c324b25587392",
  measurementId: "G-3377SYGJYX"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let roomId = new URLSearchParams(window.location.search).get('room');
    let currentTransactionPlayer = null;
    let currentTransactionType = null;
    let currentAmount = 0;
    let currentFilter = 'all';

    if (!roomId) {
      alert('No room ID provided!');
      window.location.href = 'room.html';
    }

    document.getElementById('roomIdDisplay').textContent = roomId;

    // Property data
    const propertyGroups = [
      {
        color: "#FFEF3B",
        properties: [
          { id: "piccadilly", name: "PICCADILLY", propertyValue: 280 },
          { id: "leicester", name: "LEICESTER SQUARE", propertyValue: 260 },
          { id: "coventry", name: "COVENTRY STREET", propertyValue: 260 }
        ]
      },
      {
        color: "#8B4513",
        properties: [
          { id: "oldkent", name: "OLD KENT ROAD", propertyValue: 60 },
          { id: "whitechapel", name: "WHITECHAPEL ROAD", propertyValue: 60 }
        ]
      },
      {
        color: "#0080FF",
        properties: [
          { id: "parklane", name: "PARK LANE", propertyValue: 350 },
          { id: "mayfair", name: "MAYFAIR", propertyValue: 400 }
        ]
      },
      {
        color: "#FF62ED",
        properties: [
          { id: "northumberland", name: "NORTHUMBERLAND AVE", propertyValue: 160 },
          { id: "whitehall", name: "WHITEHALL", propertyValue: 140 },
          { id: "pallmall", name: "PALL MALL", propertyValue: 140 }
        ]
      },
      {
        color: "#7DF0FF",
        properties: [
          { id: "pentonville", name: "PENTONVILLE ROAD", propertyValue: 120 },
          { id: "angel", name: "THE ANGEL, ISLINGTON", propertyValue: 100 },
          { id: "euston", name: "EUSTON ROAD", propertyValue: 100 }
        ]
      },
      {
        color: "#00A277",
        properties: [
          { id: "regent", name: "REGENT STREET", propertyValue: 300 },
          { id: "oxford", name: "OXFORD STREET", propertyValue: 300 },
          { id: "bond", name: "BOND STREET", propertyValue: 320 }
        ]
      },
      {
        color: "#FF3235",
        properties: [
          { id: "fleet", name: "FLEET STREET", propertyValue: 220 },
          { id: "strand", name: "STRAND", propertyValue: 220 },
          { id: "trafalgar", name: "TRAFALGAR SQUARE", propertyValue: 240 }
        ]
      },
      {
        color: "#FFA500",
        properties: [
          { id: "marlborough", name: "MARLBOROUGH STREET", propertyValue: 180 },
          { id: "bow", name: "BOW STREET", propertyValue: 180 },
          { id: "vine", name: "VINE STREET", propertyValue: 200 }
        ]
      },
      {
        color: "#E0E0E0",
        properties: [
          { id: "fenchurch", name: "FENCHURCH STREET", propertyValue: 200 },
          { id: "liverpool", name: "LIVERPOOL STREET", propertyValue: 200 },
          { id: "marylebone", name: "MARYLEBONE", propertyValue: 200 },
          { id: "kingscross", name: "KINGS CROSS", propertyValue: 200 }
        ]
      },
      {
        color: "#FFFFFF",
        properties: [
          { id: "electric", name: "ELECTRIC COMPANY", propertyValue: 150 },
          { id: "water", name: "WATER WORKS", propertyValue: 150 }
        ]
      }
    ];

    function formatCurrency(amount) {
      return `₹ ${amount.toLocaleString()}`;
    }

    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Load players
    function loadPlayers() {
      database.ref(`rooms/${roomId}/player1`).on('value', (snapshot) => {
        const player = snapshot.val();
        updatePlayerUI('player1', player);
      });

      database.ref(`rooms/${roomId}/player2`).on('value', (snapshot) => {
        const player = snapshot.val();
        updatePlayerUI('player2', player);
      });
    }

    function updatePlayerUI(player, data) {
      const nameEl = document.getElementById(`${player}Name`);
      const balanceEl = document.getElementById(`${player}Balance`);
      const statusEl = document.getElementById(`${player}Status`);
      const actionsEl = document.getElementById(`${player}Actions`);
      const waitingEl = document.getElementById(`${player}Waiting`);

      if (data && data.name) {
        nameEl.textContent = data.name;
        balanceEl.textContent = formatCurrency(data.balance || 3000);
        statusEl.className = (data.online || data.active) ? 'status-indicator' : 'status-indicator offline';
        
        // Enable action buttons
        actionsEl.querySelectorAll('button').forEach(btn => btn.disabled = false);
        waitingEl.style.display = 'none';
      } else {
        nameEl.textContent = 'Waiting for player...';
        balanceEl.textContent = formatCurrency(3000);
        statusEl.className = 'status-indicator offline';
        
        // Disable action buttons
        actionsEl.querySelectorAll('button').forEach(btn => btn.disabled = true);
        waitingEl.style.display = 'block';
      }
    }

    // Load properties
    async function loadProperties() {
      const roomSnapshot = await database.ref(`rooms/${roomId}`).once('value');
      const roomData = roomSnapshot.val();

      let ownedProperties = {};
      let mortgagedProperties = new Set();

      if (roomData?.player1?.properties) {
        roomData.player1.properties.forEach(prop => {
          ownedProperties[prop.id] = { owner: 'player1', name: roomData.player1.name };
          if (prop.isMortgaged) mortgagedProperties.add(prop.id);
        });
      }

      if (roomData?.player2?.properties) {
        roomData.player2.properties.forEach(prop => {
          ownedProperties[prop.id] = { owner: 'player2', name: roomData.player2.name };
          if (prop.isMortgaged) mortgagedProperties.add(prop.id);
        });
      }

      renderProperties(ownedProperties, mortgagedProperties);
    }

    function renderProperties(ownedProperties, mortgagedProperties) {
      const grid = document.getElementById('propertiesGrid');
      let html = '';

      propertyGroups.forEach(group => {
        group.properties.forEach(property => {
          const ownership = ownedProperties[property.id];
          const isMortgaged = mortgagedProperties.has(property.id);
          
          let statusText = 'Available';
          let statusClass = 'available';
          
          if (isMortgaged) {
            statusText = 'Mortgaged';
            statusClass = 'mortgaged';
          } else if (ownership) {
            statusText = `Owned by ${ownership.name}`;
            statusClass = '';
          }

          // Filter logic
          if (currentFilter === 'available' && ownership) return;
          if (currentFilter === 'owned' && !ownership) return;
          if (currentFilter === 'mortgaged' && !isMortgaged) return;

          html += `
            <div class="property-item" onclick="handlePropertyClick('${property.id}', ${ownership ? `'${ownership.owner}'` : 'null'})">
              <div class="property-color-bar" style="background: ${group.color};"></div>
              <div class="property-name-text">${property.name}</div>
              <div class="property-price">${formatCurrency(property.propertyValue)}</div>
              <div class="property-owner ${statusClass}">${statusText}</div>
            </div>
          `;
        });
      });

      grid.innerHTML = html || '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #9CA3AF;">No properties match this filter</div>';
    }

    function filterProperties(filter, element) {
      currentFilter = filter;
      document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
      element.classList.add('active');
      loadProperties();
    }

    function handlePropertyClick(propertyId, owner) {
      if (!owner) {
        window.location.href = `property.html?room=${roomId}#${propertyId}`;
      }
    }

    function openPayModal(player) {
      database.ref(`rooms/${roomId}/${player}`).once('value').then(snapshot => {
        const playerData = snapshot.val();
        if (!playerData) return;

        currentTransactionPlayer = player;
        currentTransactionType = 'pay';
        currentAmount = 0;
        updateDisplay();
        
        document.getElementById('modalTitle').textContent = 'Pay to Player';
        document.getElementById('modalSubtitle').textContent = playerData.name;
        document.getElementById('confirmBtn').className = 'modal-btn confirm-pay';
        document.getElementById('transactionModal').classList.add('show');
      });
    }

    function openCollectModal(player) {
      database.ref(`rooms/${roomId}/${player}`).once('value').then(snapshot => {
        const playerData = snapshot.val();
        if (!playerData) return;

        currentTransactionPlayer = player;
        currentTransactionType = 'collect';
        currentAmount = 0;
        updateDisplay();
        
        document.getElementById('modalTitle').textContent = 'Collect from Player';
        document.getElementById('modalSubtitle').textContent = playerData.name;
        document.getElementById('confirmBtn').className = 'modal-btn confirm-collect';
        document.getElementById('transactionModal').classList.add('show');
      });
    }

    function closeModal() {
      document.getElementById('transactionModal').classList.remove('show');
      currentAmount = 0;
    }

    function addAmount(value) {
      currentAmount += value;
      updateDisplay();
    }

    function backspace() {
      const amounts = [];
      let remaining = currentAmount;
      const denominations = [1000, 500, 200, 100, 50, 20, 10, 5, 1];
      
      for (let denom of denominations) {
        while (remaining >= denom) {
          amounts.push(denom);
          remaining -= denom;
        }
      }
      
      if (amounts.length > 0) {
        amounts.pop();
        currentAmount = amounts.reduce((sum, val) => sum + val, 0);
        updateDisplay();
      }
    }

    function updateDisplay() {
      document.getElementById('calculatorDisplay').textContent = formatCurrency(currentAmount);
    }

    async function confirmTransaction() {
      if (currentAmount === 0) {
        showToast('Please enter an amount');
        return;
      }

      const playerRef = database.ref(`rooms/${roomId}/${currentTransactionPlayer}`);
      const snapshot = await playerRef.once('value');
      const playerData = snapshot.val();

      if (!playerData) return;

      const currentBalance = playerData.balance || 3000;
      let newBalance;

      if (currentTransactionType === 'pay') {
        newBalance = currentBalance + currentAmount;
      } else {
        if (currentAmount > currentBalance) {
          showToast('Player has insufficient balance');
          return;
        }
        newBalance = currentBalance - currentAmount;
      }

      await playerRef.update({ balance: newBalance });
      
      showToast(`${currentTransactionType === 'pay' ? 'Paid' : 'Collected'} ${formatCurrency(currentAmount)}`);
      closeModal();
    }

    async function resetBalances() {
      if (!confirm('Reset both players to ₹3,000?')) return;

      await database.ref(`rooms/${roomId}/player1/balance`).set(3000);
      await database.ref(`rooms/${roomId}/player2/balance`).set(3000);
      
      showToast('Balances reset to ₹3,000');
    }

    function viewMortgaged() {
      window.location.href = `bank-mortgaged.html?room=${roomId}`;
    }

    function viewProperty() {
      window.location.href = `property.html?room=${roomId}`;
    }

    function leaveRoom() {
      if (confirm('Leave this room? This will close the room for all players.')) {
        database.ref(`rooms/${roomId}`).remove().then(() => {
          window.location.href = 'room.html';
        });
      }
    }

    // Real-time property updates
    database.ref(`rooms/${roomId}`).on('value', () => {
      loadProperties();
    });

    // Set banker as online
    database.ref(`rooms/${roomId}/banker/online`).set(true);
    database.ref(`rooms/${roomId}/banker/online`).onDisconnect().set(false);

    // Initialize
    loadPlayers();
    loadProperties();
  </script>
</body>
</html>